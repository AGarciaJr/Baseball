{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Trivia Game</h2>
  <p id="score" class="fw-bold">Score: --</p>

  <div id="question-box" class="my-3">
    <p id="question">Loading question...</p>
    <div id="choices"></div>
  </div>

  <p id="result" class="fw-bold"></p>
  <button id="next-btn" class="btn btn-primary mt-3" style="display:none;">Next Question</button>
</div>

<script>
  let currentQuestion = null;

  function loadQuestion() {
    fetch('/api/trivia/random')
      .then(res => res.json())
      .then(data => {
        currentQuestion = data;
        document.getElementById('question').textContent = data.question;

        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';

        for (const [letter, text] of Object.entries(data.choices)) {
          const btn = document.createElement('button');
          btn.className = 'btn btn-outline-secondary m-1';
          btn.textContent = `${letter}. ${text}`;
          btn.onclick = () => handleAnswer(letter);
          choicesDiv.appendChild(btn);
        }

        document.getElementById('result').textContent = '';
        document.getElementById('next-btn').style.display = 'none';
        updateScore();
      });
  }

  function handleAnswer(selected) {
    fetch('/api/trivia/answer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question_id: currentQuestion.id,
        selected_answer: selected
      })
    })
    .then(res => res.json())
    .then(data => {
      const resultText = data.correct
        ? '✅ Correct!'
        : `❌ Wrong. Correct answer: ${data.correct_answer}`;
      document.getElementById('result').textContent = resultText;

      const buttons = document.querySelectorAll('#choices button');
      buttons.forEach(btn => btn.disabled = true);

      document.getElementById('next-btn').style.display = 'inline-block';
      updateScore();

      // 🔥 Achievement toast trigger
      if (data.achievements && data.achievements.length > 0) {
        const toastBody = document.getElementById('achievementToastBody');
        toastBody.innerText = `🎉 Achievement unlocked: ${data.achievements.join(", ")}`;
        const toast = new bootstrap.Toast(document.getElementById('achievementToast'));
        toast.show();
      }
    });
  }

  function updateScore() {
    fetch('/api/trivia/score')
      .then(res => res.json())
      .then(data => {
        document.getElementById('score').textContent =
          `Score: ${data.correct} / ${data.total}`;
      });
  }

  document.getElementById('next-btn').onclick = loadQuestion;
  window.onload = loadQuestion;
</script>
<!-- Achievement Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="achievementToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="achievementToastBody">
        🎉 Achievement unlocked!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

{% endblock %}

  